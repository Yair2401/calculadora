<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Campa√±as ‚Äî Simple + PDF</title>

  <!-- jsPDF + html2canvas (para crear PDF desde el bloque de resultados) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --card-bg:#ffffff;
      --accent:#0d6efd;
      --muted:#666;
      --radius:12px;
    }
    body{
      font-family: Inter, Arial, sans-serif;
      background:#f4f6f8;
      margin:16px;
      color:#111;
    }
    .wrap{
      max-width:560px;
      margin:0 auto;
    }
    .card {
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:0 6px 18px rgba(15,20,30,0.06);
      margin-bottom:18px;
    }
    h1 {
      font-size:20px;
      margin:0 0 12px 0;
      display:flex;
      gap:8px;
      align-items:center;
    }
    label{
      display:block;
      font-weight:700;
      margin-top:10px;
    }
    input, select, button{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d6d9df;
      margin-top:6px;
      box-sizing:border-box;
      font-size:15px;
    }
    button.primary{
      background:var(--accent);
      color:#fff;
      border:none;
      margin-top:14px;
      cursor:pointer;
    }
    button.secondary{
      background:#0b5ed7;
      color:#fff;
      border:none;
      margin-top:8px;
      cursor:pointer;
    }
    small{ color:var(--muted); display:block; margin-top:6px; }
    .results {
      font-size:16px;
      line-height:1.45;
    }
    .results h3{ margin-top:0; }
    .metric {
      margin:10px 0;
      padding:10px;
      border-radius:10px;
      background:#fbfcfe;
      border:1px solid #eef2fb;
    }
    .positive { color:green; font-weight:700; }
    .warning { color:orange; font-weight:700; }
    .danger { color:red; font-weight:700; }
    .row { display:flex; gap:8px; align-items:center; }
    @media (max-width:520px){
      .card{ padding:14px; }
      h1{ font-size:18px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üìä Calculadora de Campa√±as (Simple)</h1>

      <label for="tipo">‚öôÔ∏è Tipo de Campa√±a</label>
      <select id="tipo" onchange="toggleProveedor()">
        <option value="bodega">Bodega</option>
        <option value="dropshipping">Dropshipping</option>
      </select>

      <label for="gasto">üí∞ Gasto en Ads ($)</label>
      <input id="gasto" type="number" placeholder="Ej: 225717">

      <label for="conversaciones">üí¨ Conversaciones Iniciadas</label>
      <input id="conversaciones" type="number" placeholder="Ej: 570">

      <label for="ventas">üõí N√∫mero de Ventas</label>
      <input id="ventas" type="number" placeholder="Ej: 6">

      <label for="pares">üì¶ Total de Unidades / Pares Vendidos</label>
      <input id="pares" type="number" placeholder="Ej: 7">

      <label for="precio">üíµ Precio por Unidad ($)</label>
      <input id="precio" type="number" placeholder="Ej: 169900">

      <!-- Solo para dropshipping -->
      <div id="proveedorBox" style="display:none;">
        <label for="costoProveedor">üì¶ Costo del Proveedor / Costo por unidad ($)</label>
        <input id="costoProveedor" type="number" placeholder="Ej: 80000">
        <small>Incluye costo del producto y/o env√≠o por unidad (si aplica).</small>
      </div>

      <button class="primary" onclick="calcular()">Calcular</button>
      <button class="secondary" onclick="descargarPDF()">üì• Descargar Resumen en PDF</button>
    </div>

    <div id="resultadosCard" class="card" aria-live="polite">
      <div id="resultados" class="results">
        <h3>üìà Resultados</h3>
        <p class="metric">Completa los datos y presiona <b>Calcular</b>.</p>
      </div>
    </div>
  </div>

  <script>
    // --- Utilidades ---
    function formatoCOP(valor) {
      // Convierte a n√∫mero y maneja NaN
      let n = Number(valor) || 0;
      return n.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });
    }

    function toggleProveedor(){
      const tipo = document.getElementById('tipo').value;
      document.getElementById('proveedorBox').style.display = (tipo === 'dropshipping') ? 'block' : 'none';
    }

    // --- L√≥gica de c√°lculo (igual a la "antigua") ---
    function calcular(){
      const tipo = document.getElementById('tipo').value;
      const gasto = Number(document.getElementById('gasto').value) || 0;
      const conversaciones = Number(document.getElementById('conversaciones').value) || 0;
      const ventas = Number(document.getElementById('ventas').value) || 0;
      const pares = Number(document.getElementById('pares').value) || 0;
      const precio = Number(document.getElementById('precio').value) || 0;
      const costoProveedor = (tipo === 'dropshipping') ? (Number(document.getElementById('costoProveedor').value) || 0) : 0;

      // Validaciones b√°sicas
      if (gasto === 0 || conversaciones === 0 || ventas === 0 || pares === 0 || precio === 0) {
        document.getElementById('resultados').innerHTML = `<h3>üìà Resultados</h3>
          <p class="metric">‚ö†Ô∏è Completa todos los campos obligatorios para calcular (gasto, conversaciones, ventas, unidades y precio).</p>`;
        return;
      }

      // C√°lculos
      const costoPorConversacion = gasto / conversaciones;
      const tasaConversion = (ventas / conversaciones) * 100;
      const ingresosTotales = pares * precio;
      const costoPorVenta = gasto / ventas;
      const costoPorUnidad = gasto / pares;
      const roas = gasto > 0 ? ingresosTotales / gasto : 0;

      // Si se tiene costo del proveedor (dropshipping) lo usamos para utilidad
      const costoProductoTotal = (costoProveedor > 0) ? (pares * costoProveedor) : 0;
      const utilidadNeta = ingresosTotales - gasto - costoProductoTotal;
      const gananciaUnitaria = (costoProveedor > 0) ? (precio - costoProveedor) : null;

      // Mensaje seg√∫n ROAS y utilidad
      let estadoHtml = '';
      if (roas < 1 || utilidadNeta < 0) {
        estadoHtml = `<p class="danger">‚ùå Resultado: P√©rdida o rentabilidad negativa.</p>`;
      } else if (roas >= 1 && roas < 3) {
        estadoHtml = `<p class="warning">‚ö†Ô∏è Resultado: Rentabilidad baja ‚Äî hay que mejorar.</p>`;
      } else {
        estadoHtml = `<p class="positive">‚úÖ Resultado: ROAS saludable.</p>`;
      }

      // Construir HTML de resultados (simple y claro)
      let html = `<h3>üìà Resultados (${ tipo === 'bodega' ? 'Bodega' : 'Dropshipping' })</h3>`;

      html += `<div class="metric"><b>Costo por Conversaci√≥n:</b> ${formatoCOP(costoPorConversacion)}
                <br><small>Lo que pagaste en Ads por cada persona que te escribi√≥.</small></div>`;

      html += `<div class="metric"><b>Tasa de Conversi√≥n:</b> ${tasaConversion.toFixed(2)}%
                <br><small>Porcentaje de conversaciones que terminaron en venta.</small></div>`;

      html += `<div class="metric"><b>Ingresos Totales:</b> ${formatoCOP(ingresosTotales)}
                <br><small>Dinero recibido por ventas (unidades √ó precio).</small></div>`;

      html += `<div class="metric"><b>Costo por Venta (CAC):</b> ${formatoCOP(costoPorVenta)}
                <br><small>Promedio gastado en Ads para conseguir cada cliente.</small></div>`;

      html += `<div class="metric"><b>Costo por Unidad Vendida (Ads):</b> ${formatoCOP(costoPorUnidad)}
                <br><small>Parte del gasto en Ads que corresponde a cada unidad vendida.</small></div>`;

      html += `<div class="metric"><b>ROAS:</b> ${roas.toFixed(2)}x
                <br><small>Por cada $1 en publicidad, regresaron ${roas.toFixed(2)} en ventas.</small></div>`;

      html += `<div class="metric"><b>Unidades Vendidas:</b> ${pares}
                <br><small>Cantidad total de productos vendidos.</small></div>`;

      if (costoProveedor > 0) {
        html += `<div class="metric"><b>Costo proveedor total:</b> ${formatoCOP(costoProductoTotal)}
                  <br><small>Suma de los costos que pagaste al proveedor (unidades √ó costo por unidad).</small></div>`;
        html += `<div class="metric"><b>Ganancia por unidad (estimada):</b> ${formatoCOP(gananciaUnitaria)}
                  <br><small>(Precio de venta ‚àí costo proveedor). Si negativo, la unidad pierde dinero.</small></div>`;
      } else {
        html += `<div class="metric"><b>Ganancia por unidad (no calculada):</b> ‚Äî 
                  <br><small>Ingresa Costo del proveedor para ver ganancia por unidad.</small></div>`;
      }

      html += `<div class="metric"><b>Utilidad Neta Estimada:</b> ${formatoCOP(utilidadNeta)}
                <br><small>(Ingresos ‚àí Gasto en Ads ‚àí Costo proveedor total). Valor total del per√≠odo.</small></div>`;

      html += estadoHtml;
      html += `<div class="metric"><b>Consejo r√°pido:</b> `;
      if (roas < 1 || utilidadNeta < 0) {
        html += `Reduce costos (negocia proveedor / baja coste de env√≠o), sube precio o baja el CAC con remarketing.`;
      } else if (roas < 3) {
        html += `Optimiza creativos y audiencias, aplica remarketing y prueba peque√±os aumentos de precio.`;
      } else {
        html += `Escala gradualmente invirtiendo m√°s en lo que ya funciona.`;
      }
      html += `</div>`;

      document.getElementById('resultados').innerHTML = html;
    }

    // --- Generar PDF (captura visual del div #resultados) ---
    async function descargarPDF() {
      const resultadosEl = document.getElementById('resultados');

      // Si no hay contenido calculado, no hacer nada √∫til
      if (!resultadosEl || resultadosEl.innerText.trim().length === 0 || resultadosEl.innerText.includes('Completa')) {
        alert('Primero calcula los resultados y luego descarga el PDF.');
        return;
      }

      try {
        // Generar canvas de alta resoluci√≥n
        const canvas = await html2canvas(resultadosEl, { scale: 2, useCORS: true, backgroundColor: null });
        const imgData = canvas.toDataURL('image/png');

        // Crear PDF (A4 vertical)
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

        // Calcular tama√±o de la imagen en mm manteniendo ratio
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // Ajuste: dejar peque√±os m√°rgenes
        const margin = 10;
        const maxWidth = pageWidth - margin * 2;
        const maxHeight = pageHeight - margin * 2;

        const imgProps = pdf.getImageProperties(imgData);
        const imgWidthPx = imgProps.width;
        const imgHeightPx = imgProps.height;
        const pxToMm = (mmPerInch => mmPerInch / 96)(25.4); // aproximado (not used directly)

        // Calcular diferencia de escala para ajustar a ancho m√°ximo
        const ratio = Math.min(maxWidth / imgWidthPx * 96 / 25.4 * 25.4/96, maxHeight / imgHeightPx * 96 / 25.4 * 25.4/96);
        // (Simplificamos: usaremos ancho proporcional)
        const renderWidth = maxWidth;
        const renderHeight = (imgHeightPx * renderWidth) / imgWidthPx;

        pdf.addImage(imgData, 'PNG', margin, margin, renderWidth, renderHeight);
        pdf.save('resumen_campana.pdf');
      } catch (err) {
        console.error(err);
        alert('Error creando el PDF. Intenta nuevamente o descarga desde escritorio.');
      }
    }

    // Inicializar (ocultar proveedor si es bodega)
    toggleProveedor();
  </script>
</body>
</html>
